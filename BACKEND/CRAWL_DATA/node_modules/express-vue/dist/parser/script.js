'use strict';

Object.defineProperty(exports, "__esModule", {
    value: true
});

var _models = require('../models');

var _requireFromString = require('require-from-string');

var _requireFromString2 = _interopRequireDefault(_requireFromString);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var scriptRegex = /(<script.*?>)([\s\S]*?)(<\/script>)/gm;

function dataParser(script, defaults, type) {
    var finalScript = {};
    for (var element in script) {
        if (script.hasOwnProperty(element)) {
            if (element === 'data') {
                (function () {
                    var data = new _models.DataObject(script.data(), defaults.options.data, type).data;
                    finalScript[element] = function () {
                        return data;
                    };
                })();
            } else {
                finalScript[element] = script[element];
            }
        }
    }
    return finalScript;
}

function scriptParser(script, defaults, type, regex) {
    if (!regex) {
        regex = scriptRegex;
    }
    var options = {
        'presets': ['es2015']
    };
    var scriptArray = script.match(regex) || [];
    if (scriptArray.length === 0) {
        var error = 'I had an error processing this script.\n' + script;
        console.error(new Error(error));
        return null;
    }
    var scriptString = scriptArray[0].replace(regex, '$2');
    var babelScript = require('babel-core').transform(scriptString, options);
    var evalScript = (0, _requireFromString2.default)(babelScript.code);
    var finalScript = dataParser(evalScript.default, defaults, type);
    return finalScript;
}

exports.default = scriptParser;
module.exports = exports['default'];